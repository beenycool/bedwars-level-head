<<<<<<< SEARCH
app.use((req, res, next) => {
  const start = process.hrtime.bigint();
  res.on('finish', () => {
    const end = process.hrtime.bigint();
    const durationSeconds = Number(end - start) / 1_000_000_000;
    const durationMs = durationSeconds * 1000;
    const routeLabel =
      typeof res.locals.metricsRoute === 'string'
        ? res.locals.metricsRoute
        : req.baseUrl
          ? `${req.baseUrl}${req.route?.path ?? ''}`
          : req.route?.path ?? req.path;
    observeRequest(req.method, routeLabel, res.statusCode, durationSeconds);

    const rawTarget = req.originalUrl ?? req.url ?? routeLabel;
    const target = sanitizeUrlForLogs(rawTarget);
    const message = `[request] ${req.method} ${target} -> ${res.statusCode} (${durationMs.toFixed(2)} ms)`;
    if (res.statusCode >= 500) {
      console.error(message);
    } else if (res.statusCode === 429) {
      // Rate limit blocks are logged separately by the rate limit middleware
      // Skip duplicate logging here
    } else if (res.statusCode >= 400) {
      console.warn(message);
    } else {
      console.info(message);
    }
  });
  next();
});
=======
app.use((req, res, next) => {
  const start = process.hrtime.bigint();
  res.on('finish', () => {
    const end = process.hrtime.bigint();
    const durationSeconds = Number(end - start) / 1_000_000_000;
    const routeLabel =
      typeof res.locals.metricsRoute === 'string'
        ? res.locals.metricsRoute
        : req.baseUrl
          ? `${req.baseUrl}${req.route?.path ?? ''}`
          : req.route?.path ?? req.path;
    observeRequest(req.method, routeLabel, res.statusCode, durationSeconds);
  });
  next();
});
>>>>>>> REPLACE
